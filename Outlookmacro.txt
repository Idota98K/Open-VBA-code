'機密に触れそうな部分は削除しています
Option Explicit
Dim rowcount As Long
Dim sheetn

Sub GetCIS()
    Dim bangou%
    Dim Operater As Worksheet
    Dim newsh As Worksheet
    Dim oApp As New Outlook.Application
    Dim oNs As Outlook.Namespace
    Dim maillist As Items
    Dim days
    Dim oF As Folders
    Dim oF2 As Folder
    Dim i As Long, j As Long, k As Long, l As Long
    Dim today As Date
    Dim strFilter As String
    Dim Filtercount As Long
    Dim count(400) As Long
    Dim ccc(100) As Long
    Dim CIS(400)
    Dim CIS1
    Dim CIS11
    Dim CIS2
    Dim CIS22
    Dim Subjectnumber
    Dim LstRow1
    Dim ankenstart
    Dim ankenend
    Dim Ankenzyouhou

    Set Operater = ThisWorkbook.Worksheets("OutlookからMARUI")
    Worksheets.Add After:=Operater
    Set newsh = ActiveSheet
    newsh.name = "CISMARUIモニター" & ThisWorkbook.Sheets.count - 1
    sheetn = "CISMARUIモニター" & ThisWorkbook.Sheets.count - 1
    
    Columns("A").ColumnWidth = 16
    Columns("C").ColumnWidth = 9
    Columns("D").ColumnWidth = 11
    Columns("R").ColumnWidth = 13
    Columns("S").ColumnWidth = 254.9
    Set oNs = oApp.GetNamespace("MAPI")
    Set oF = oNs.GetDefaultFolder(olFolderInbox).Folders
    Set oF2 = oNs.GetDefaultFolder(olFolderInbox).Folders(Worksheets("OutlookからMARUI").Cells(2, 2).Value)
    today = Date
    days = DateAdd("d", -1 * (Worksheets("OutlookからMARUI").Cells(7, 2).Value), Date)
    
    strFilter = "[受信日時] <= '" & now & _
                 "' AND [受信日時] >= '" & days & " 23:59'"
    k = 1
    Filtercount = 1
    
    Worksheets(sheetn).Cells(1, 1).Value = "日時"
    Worksheets(sheetn).Cells(1, 2).Value = "タイプ"
    Worksheets(sheetn).Cells(1, 3).Value = "対象工程"
    Worksheets(sheetn).Cells(1, 4).Value = "対象装置"
    Worksheets(sheetn).Cells(1, 5).Value = "コメント"
    
    If Worksheets("OutlookからMARUI").Cells(1, 2).Value = "受信トレイ" Then
    
        Set maillist = oNs.GetDefaultFolder(olFolderInbox).Items.Restrict(strFilter)
        maillist.sort "[ReceivedTime]", True
        
        CIS(k) = Filtercount
        
        For i = 1 To maillist.count
            If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                If InStr(maillist.Item(i).Subject, "IMX") <> 0 Then
                    count(Filtercount) = i
                    Filtercount = Filtercount + 1
                End If
                
            End If
        Next
        
        If CIS(k) <> 1 Or Filtercount <> 1 Then
        
            For i = CIS(k) To Filtercount - 1
                Subjectnumber = InStr(maillist.Item(count(i)).Subject, "IMX")
                CIS1 = Split(maillist.Item(count(i)).Body, vbLf)
                Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(count(i)).Subject, Subjectnumber, 6)
                Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(count(i)).ReceivedTime
                
                For l = 0 To UBound(CIS1)
                    
                    If InStr(CIS1(l), "対象工程") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 3).Value = Mid(CIS1(l), InStr(CIS1(l), "：") + 1)
                    End If
                    
                    If InStr(CIS1(l), "対象装置") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 4).Value = Mid(CIS1(l), InStr(CIS1(l), "：") + 1)
                    End If
                    
                    If InStr(CIS1(l), "コメント") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 5).Value = CIS1(l + 1)
                    End If
                    
                Next
            
            Next
            
        End If
    Else
        For j = 1 To oF.count
            If oF(j) = Worksheets("OutlookからMARUI").Cells(1, 2).Value Then
            
                Set maillist = oF(j).Items.Restrict(strFilter)
                maillist.sort "[ReceivedTime]", True
                
                CIS(k) = Filtercount
                
                For i = 1 To maillist.count
                    If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                        If InStr(maillist.Item(i).Subject, "IMX") <> 0 Then
                            count(Filtercount) = i
                            Filtercount = Filtercount + 1
                        End If
                        
                    End If
                Next
                
                If CIS(k) <> 1 Or Filtercount <> 1 Then
                
                    For i = CIS(k) To Filtercount - 1
                        Subjectnumber = InStr(maillist.Item(count(i)).Subject, "IMX")
                        CIS1 = Split(maillist.Item(count(i)).Body, vbLf)
                        ankenstart = InStr(maillist.Item(count(i)).Body, "■案件情報")
                        ankenend = InStr(maillist.Item(count(i)).Body, "■配布先")
                        Ankenzyouhou = Mid(maillist.Item(count(i)).Body, ankenstart, ankenend - ankenstart)
                        CIS11 = Split(Ankenzyouhou, vbLf)
                        Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(count(i)).Subject, Subjectnumber, 6)
                        Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(count(i)).ReceivedTime
                        rowcount = 3
                        
                        For l = 0 To UBound(CIS1)
                              
                            If InStr(CIS1(l), "コメント") <> 0 Then
                                Worksheets(sheetn).Cells(i + 1, 19).Value = CIS1(l + 1)
                            End If
                            
                        Next
                        
                        For l = 0 To UBound(CIS11)
                            
                            Call commentout(i, CIS11(l), rowcount, "案件No")
                            Call commentout(i, CIS11(l), rowcount, "件名")
                            Call commentout(i, CIS11(l), rowcount, "ロットNo")
                            Call commentout(i, CIS11(l), rowcount, "マークロット")
                            Call commentout(i, CIS11(l), rowcount, "対象工程")
                            Call commentout(i, CIS11(l), rowcount, "対象装置")
                            Call commentout(i, CIS11(l), rowcount, "優先度")
                            Call commentout(i, CIS11(l), rowcount, "作業数")
                            Call commentout(i, CIS11(l), rowcount, "発生数")
                            Call commentout(i, CIS11(l), rowcount, "不良率")
                            Call commentout(i, CIS11(l), rowcount, "不適合項目")
                            Call commentout(i, CIS11(l), rowcount, "原因分類1")
                            Call commentout(i, CIS11(l), rowcount, "原因分類2")
                            Call commentout(i, CIS11(l), rowcount, "不良分類1")
                            Call commentout(i, CIS11(l), rowcount, "不良分類2")
                            Call commentout(i, CIS11(l), rowcount, "対象ロット")
                            
                        Next
                    
                    Next
                    
                End If
                
                k = k + 1
                
            ElseIf oF(j) = Worksheets("OutlookからMARUI").Cells(2, 2).Value Then
                
                Set maillist = oF(j).Items.Restrict(strFilter)
                maillist.sort "[ReceivedTime]", True
                
                CIS(k) = Filtercount
                
                For i = 1 To maillist.count
                    
                    If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                        If InStr(maillist.Item(i).Subject, "IMX") <> 0 Then
                           
                            count(Filtercount) = i
                            Filtercount = Filtercount + 1
                            
                        End If
                        
                    End If
                Next
                
                If CIS(k) <> 1 Or Filtercount <> 1 Then
                    For i = CIS(k) To Filtercount - 1
                        Subjectnumber = InStr(maillist.Item(count(i)).Subject, "IMX")
                        CIS2 = Split(maillist.Item(count(i)).Body, vbLf)
                        ankenstart = InStr(maillist.Item(count(i)).Body, "■案件情報")
                        ankenend = InStr(maillist.Item(count(i)).Body, "■配布先")
                        Ankenzyouhou = Mid(maillist.Item(count(i)).Body, ankenstart, ankenend - ankenstart)
                        CIS22 = Split(Ankenzyouhou, vbLf)
                        Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(count(i)).Subject, Subjectnumber, 6)
                        Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(count(i)).ReceivedTime
                        rowcount = 3
                        
                        For l = 0 To UBound(CIS2)
                        
                            If InStr(CIS2(l), "コメント") <> 0 Then
                                Worksheets(sheetn).Cells(i + 1, 19).Value = CIS2(l + 1)
                            End If
                                       
                        Next
                        For l = 0 To UBound(CIS22)
                        
                            Call commentout(i, CIS22(l), rowcount, "案件No")
                            Call commentout(i, CIS22(l), rowcount, "件名")
                            Call commentout(i, CIS22(l), rowcount, "ロットNo")
                            Call commentout(i, CIS22(l), rowcount, "マークロット")
                            Call commentout(i, CIS22(l), rowcount, "対象工程")
                            Call commentout(i, CIS22(l), rowcount, "対象装置")
                            Call commentout(i, CIS22(l), rowcount, "優先度")
                            Call commentout(i, CIS22(l), rowcount, "作業数")
                            Call commentout(i, CIS22(l), rowcount, "発生数")
                            Call commentout(i, CIS22(l), rowcount, "不良率")
                            Call commentout(i, CIS22(l), rowcount, "不適合項目")
                            Call commentout(i, CIS22(l), rowcount, "原因分類1")
                            Call commentout(i, CIS22(l), rowcount, "原因分類2")
                            Call commentout(i, CIS22(l), rowcount, "不良分類1")
                            Call commentout(i, CIS22(l), rowcount, "不良分類2")
                            Call commentout(i, CIS22(l), rowcount, "対象ロット")
                            
                            
                        Next
                    
                    Next
                    
                End If
                
                k = k + 1
                
            End If
            
        Next
        
    End If
    LstRow1 = Worksheets(sheetn).Cells(Rows.count, 1).End(xlUp).row
    With ActiveSheet
    
        .sort.SortFields.Clear
        
        .sort.SortFields.Add _
            Key:=ActiveSheet.Cells(2, 1), _
            Order:=xlDescending
        
        With .sort
            .SetRange Range(Cells(2, 1), Cells(LstRow1, 19))
            .Header = xlNo
            .Orientation = xlTopToBottom
            .Apply
            
        End With
        
    End With
    Range("A:D").HorizontalAlignment = xlCenter
'↓この書き方でも時間指定できる
'        If DateValue(maillist.Item(i).ReceivedTime) <= days Then
'            If InStr(maillist.Item(i).Subject, "MARUI") Then
'                Cells(i, 1).Value = maillist.Item(i).Subject
'            End If
'        End If

   
End Sub

Sub GetVos()
    Dim bangou%
    Dim Operater As Worksheet
    Dim newsh As Worksheet
    Dim oApp As New Outlook.Application
    Dim oNs As Outlook.Namespace
    Dim maillist As Items
    Dim days
    Dim oF As Folders
    Dim oF2 As Folder
    Dim i As Long, j As Long, k As Long, l As Long
    Dim today As Date
    Dim strFilter As String
    Dim FiltercountV As Long
    Dim countV(1000) As Long
    Dim ccc(100) As Long
    Dim Vos(600)
    Dim Vos1
    Dim Vos11
    Dim Vos2
    Dim Vos22
    Dim Subjectnumber
    Dim LstRow1
    Dim ankenstart
    Dim ankenend
    Dim Ankenzyouhou
    
    Set Operater = ThisWorkbook.Worksheets("Sheet1")
    Worksheets.Add After:=Operater
    Set newsh = ActiveSheet
    newsh.name = "VosMARUIモニター" & ThisWorkbook.Sheets.count - 1
    sheetn = "VosMARUIモニター" & ThisWorkbook.Sheets.count - 1
    
    Columns("A").ColumnWidth = 16
    Columns("C").ColumnWidth = 9
    Columns("D").ColumnWidth = 11
    Columns("R").ColumnWidth = 13
    Columns("S").ColumnWidth = 254.9
    Set oNs = oApp.GetNamespace("MAPI")
    Set oF = oNs.GetDefaultFolder(olFolderInbox).Folders
    Set oF2 = oNs.GetDefaultFolder(olFolderInbox).Folders(Worksheets("Sheet1").Cells(2, 2).Value)
    today = Date
    days = DateAdd("d", -1 * (Worksheets("Sheet1").Cells(7, 2).Value), Date)
    
    strFilter = "[受信日時] <= '" & now & _
                 "' AND [受信日時] >= '" & days & " 23:59'"
    k = 1
    FiltercountV = 1
    
    Worksheets(sheetn).Cells(1, 1).Value = "日時"
    Worksheets(sheetn).Cells(1, 2).Value = "タイプ"
    Worksheets(sheetn).Cells(1, 3).Value = "対象工程"
    Worksheets(sheetn).Cells(1, 4).Value = "対象装置"
    Worksheets(sheetn).Cells(1, 5).Value = "コメント"
    
    If Worksheets("Sheet1").Cells(1, 2).Value = "受信トレイ" Then
    
        Set maillist = oNs.GetDefaultFolder(olFolderInbox).Items.Restrict(strFilter)
        maillist.sort "[ReceivedTime]", True
        Vos(k) = FiltercountV
        
        For i = 1 To maillist.count
            If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                If InStr(maillist.Item(i).Subject, "CXN") <> 0 Then
                    countV(FiltercountV) = i
                    FiltercountV = FiltercountV + 1
                End If
                
            End If
        Next
        
        If Vos(k) <> 1 Or FiltercountV <> 1 Then
        
            For i = Vos(k) To FiltercountV - 1
            
                Subjectnumber = InStr(maillist.Item(countV(i)).Subject, "CXN")
                Vos1 = Split(maillist.Item(countV(i)).Body, vbLf)
                ankenstart = InStr(maillist.Item(countV(i)).Body, "■案件情報")
                ankenend = InStr(maillist.Item(countV(i)).Body, "■配布先")
                Ankenzyouhou = Mid(maillist.Item(countV(i)).Body, ankenstart, ankenend - ankenstart)
                Vos11 = Split(Ankenzyouhou, vbLf)
                Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(countV(i)).Subject, Subjectnumber, 7)
                Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(countV(i)).ReceivedTime
                
                For l = 0 To UBound(Vos1)
                
                    If InStr(Vos1(l), "対象工程") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 3).Value = Mid(Vos1(l), InStr(Vos1(l), "：") + 1)
                    End If
                    
                    If InStr(Vos1(l), "対象装置") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 4).Value = Mid(Vos1(l), InStr(Vos1(l), "：") + 1)
                    End If
                    
                    If InStr(Vos1(l), "コメント") <> 0 Then
                        Worksheets(sheetn).Cells(i + 1, 5).Value = Vos1(l + 1)
                    End If
                    
                Next
                
            Next
            
        End If
    
    Else
    
        For j = 1 To oF.count
            If oF(j) = Worksheets("Sheet1").Cells(1, 2).Value Then
            
                Set maillist = oF(j).Items.Restrict(strFilter)
                maillist.sort "[ReceivedTime]", True
                Vos(k) = FiltercountV
                
                For i = 1 To maillist.count
                    If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                        If InStr(maillist.Item(i).Subject, "CXN") <> 0 Then
                            countV(FiltercountV) = i
                            FiltercountV = FiltercountV + 1
                        End If
                        
                    End If
                Next
                If Vos(k) <> 1 Or FiltercountV <> 1 Then
                    For i = Vos(k) To FiltercountV - 1
                    
                        Subjectnumber = InStr(maillist.Item(countV(i)).Subject, "CXN")
                        Vos1 = Split(maillist.Item(countV(i)).Body, vbLf)
                        ankenstart = InStr(maillist.Item(countV(i)).Body, "■案件情報")
                        ankenend = InStr(maillist.Item(countV(i)).Body, "■配布先")
                        Ankenzyouhou = Mid(maillist.Item(countV(i)).Body, ankenstart, ankenend - ankenstart)
                        Vos11 = Split(Ankenzyouhou, vbLf)
                        Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(countV(i)).Subject, Subjectnumber, 7)
                        Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(countV(i)).ReceivedTime
                        rowcount = 3
                        
                        For l = 0 To UBound(Vos1)
                            
                            If InStr(Vos1(l), "コメント") <> 0 Then
                                Worksheets(sheetn).Cells(i + 1, 19).Value = Vos1(l + 1)
                            End If
                        Next
                        
                        For l = 0 To UBound(Vos11)
                            
                            Call commentout(i, Vos11(l), rowcount, "案件No")
                            Call commentout(i, Vos11(l), rowcount, "件名")
                            Call commentout(i, Vos11(l), rowcount, "ロットNo")
                            Call commentout(i, Vos11(l), rowcount, "マークロット")
                            Call commentout(i, Vos11(l), rowcount, "対象工程")
                            Call commentout(i, Vos11(l), rowcount, "対象装置")
                            Call commentout(i, Vos11(l), rowcount, "優先度")
                            Call commentout(i, Vos11(l), rowcount, "作業数")
                            Call commentout(i, Vos11(l), rowcount, "発生数")
                            Call commentout(i, Vos11(l), rowcount, "不良率")
                            Call commentout(i, Vos11(l), rowcount, "不適合項目")
                            Call commentout(i, Vos11(l), rowcount, "原因分類1")
                            Call commentout(i, Vos11(l), rowcount, "原因分類2")
                            Call commentout(i, Vos11(l), rowcount, "不良分類1")
                            Call commentout(i, Vos11(l), rowcount, "不良分類2")
                            Call commentout(i, Vos11(l), rowcount, "対象ロット")
                            
                        Next
                        
                    Next
                    
                End If
                
                k = k + 1
                
            ElseIf oF(j) = Worksheets("Sheet1").Cells(2, 2).Value Then
    
                Set maillist = oF(j).Items.Restrict(strFilter)
                maillist.sort "[ReceivedTime]", True
                Vos(k) = FiltercountV
                
                For i = 1 To maillist.count
                
                    If InStr(maillist.Item(i).Subject, "MARUI") <> 0 Then
                    
                        If InStr(maillist.Item(i).Subject, "CXN") <> 0 Then
                           
                            countV(FiltercountV) = i
                            FiltercountV = FiltercountV + 1
                            
                        End If
                        
                    End If
                    
                Next
                
                If Vos(k) <> 1 Or FiltercountV <> 1 Then
                
                    For i = Vos(k) To FiltercountV - 1
                    
                        Subjectnumber = InStr(maillist.Item(countV(i)).Subject, "CXN")
                        Vos2 = Split(maillist.Item(countV(i)).Body, vbLf)
                        ankenstart = InStr(maillist.Item(countV(i)).Body, "■案件情報")
                        ankenend = InStr(maillist.Item(countV(i)).Body, "■配布先")
                        Ankenzyouhou = Mid(maillist.Item(countV(i)).Body, ankenstart, ankenend - ankenstart)
                        Vos22 = Split(Ankenzyouhou, vbLf)
                        Worksheets(sheetn).Cells(i + 1, 2).Value = Mid(maillist.Item(countV(i)).Subject, Subjectnumber, 7)
                        Worksheets(sheetn).Cells(i + 1, 1).Value = maillist.Item(countV(i)).ReceivedTime
                        rowcount = 3
                        
                        For l = 0 To UBound(Vos2)
                            
                            If InStr(Vos2(l), "コメント") <> 0 Then
                                Worksheets(sheetn).Cells(i + 1, 19).Value = Vos2(l + 1)
                            End If
                        Next
                        
                        For l = 0 To UBound(Vos22)
                            
                            Call commentout(i, Vos22(l), rowcount, "案件No")
                            Call commentout(i, Vos22(l), rowcount, "件名")
                            Call commentout(i, Vos22(l), rowcount, "ロットNo")
                            Call commentout(i, Vos22(l), rowcount, "マークロット")
                            Call commentout(i, Vos22(l), rowcount, "対象工程")
                            Call commentout(i, Vos22(l), rowcount, "対象装置")
                            Call commentout(i, Vos22(l), rowcount, "優先度")
                            Call commentout(i, Vos22(l), rowcount, "作業数")
                            Call commentout(i, Vos22(l), rowcount, "発生数")
                            Call commentout(i, Vos22(l), rowcount, "不良率")
                            Call commentout(i, Vos22(l), rowcount, "不適合項目")
                            Call commentout(i, Vos22(l), rowcount, "原因分類1")
                            Call commentout(i, Vos22(l), rowcount, "原因分類2")
                            Call commentout(i, Vos22(l), rowcount, "不良分類1")
                            Call commentout(i, Vos22(l), rowcount, "不良分類2")
                            Call commentout(i, Vos22(l), rowcount, "対象ロット")
                            
                        Next
                        
                    Next
                    
                End If
                
                k = k + 1
                
            End If
            
        Next
        
    End If
    
    LstRow1 = Worksheets(sheetn).Cells(Rows.count, 1).End(xlUp).row
    
    With ActiveSheet
    
        .sort.SortFields.Clear
        
        .sort.SortFields.Add _
            Key:=ActiveSheet.Cells(2, 1), _
            Order:=xlDescending
        
        With .sort
            .SetRange Range(Cells(2, 1), Cells(LstRow1, 19))
            .Header = xlNo
            .Orientation = xlTopToBottom
            .Apply
            
        End With
        
    End With
    Range("A:D").HorizontalAlignment = xlCenter
'↓この書き方でも時間指定できる
'        If DateValue(maillist.Item(i).ReceivedTime) <= days Then
'            If InStr(maillist.Item(i).Subject, "MARUI") Then
'                Cells(i, 1).Value = maillist.Item(i).Subject
'            End If
'        End If
    

   
End Sub

Sub commentout(ByVal i As Long, ByVal j As String, R As Long, ByVal mozi As String)
    
    If InStr(j, mozi) <> 0 Then
        Worksheets(sheetn).Cells(i + 1, R).Value = Mid(j, InStr(j, "：") + 1)
        R = R + 1
    End If
    
End Sub

